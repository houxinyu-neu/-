# `Vue`的虚拟`DOM`

好饭不怕晚，沉淀下来收收心！我们虽然走的慢，但是却从未停下脚步！

## `DOM`解析过程

+ `HTML`和`CSS`并行加载。`HTML`解析成`DOM Tree`的过程不会受到`CSS`的加载阻塞。但是`DOM Tree`和`CSS Tree`结合生成`Render Tree`的过程会收到`CSS`的阻塞。
+ `JavaScript`阻塞`DOM`解析和`DOM`渲染。但浏览器会偷看资源进行加载。如果设置`defer`或`async`属性可异步加载，其中`async`异步加载后立即执行，`defer`异步加载后等到`DOM`渲染完执行。

## 操作真实`DOM`的代价

用我们传统的开发模式，原生JS或JQ操作DOM时，浏览器会从构建DOM树开始从头到尾执行一遍流程。在一次操作中，我需要更新10个DOM节点，浏览器收到第一个DOM请求后并不知道还有9次更新操作，因此会马上执行流程，最终执行10次。例如，第一次计算完，紧接着下一个DOM更新请求，这个节点的坐标值就变了，前一次计算为无用功。计算DOM节点坐标值等都是白白浪费的性能。即使计算机硬件一直在迭代更新，操作DOM的代价仍旧是昂贵的，频繁操作还是会出现页面卡顿，影响用户体验。

## 虚拟`DOM`的优势

为**解决浏览器性能问题**。将多次操作`DOM`的更新`diff`一次性映射到`DOM`树中(`JavaScript`对象)，再进行后续操作。大大节约性能开销。

<img src="../../../AppData/Roaming/Typora/typora-user-images/image-20200705151229706.png" alt="image-20200705151229706" style="zoom:50%;" />

## `Diff`操作

更新`VDOM`时候传统深度优先的复杂度高达O(n³)，因此需要平层比较的`Diff`算法。

1. 深度遍历记录差异。

2. 通过`walk`方法**创建需要补丁数组**，通过`patch`方法对**相应元素打上相应补丁。**

+ 节点类型改变，整体替换`replace`。
+ 节点属性改变。比较新老属性，进行更新操作`props`。
+ 节点文本改变。替换文本值`text`。
+ 新增、删除、移动节点。若没有`key`将会比较所有节点，若有`key`可在具体位置操作，效率较高。

3. 深度遍历将`vDom`映射成真实`DOM`。

