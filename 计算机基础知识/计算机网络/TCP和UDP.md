# 关于TCP和UDP

### TCP和UDP对比

1. TCP

- 面向连接，提供可交付服务
- 端对端的全双共通信
- 面向字节流，一般进程是数据块通信，TCP进程将其看做一连串无结构字节流。

1. UDP

- 无连接，不可靠服务。
- 一对一或一对多或多对多
- 面向报文流。
- 首部开销比TCP小。(8vs20)

### TCP的三次握手

1. TCP三次握手（三次报文段握手）并不传递数据，传递报文段建立数据的连接。
2. 名词

| 名词 | 解释     | 作用                 |
| ---- | -------- | -------------------- |
| SYN  | 同步标志 | 请求建立连接         |
| ACK  | 确认标志 | 同意建立连接         |
| seq  | 序列号   | 报文段首字节序列编号 |
| ack  | 确认号   | 接收端期待的数据编号 |

3. 过程

+ 第一次握手，客户端发送SYN=1请求同步和自身序列号，进入SYN-SENT状态，请求同步。

+ 第二次握手，服务端接受客户端的同步标识和序列号，并发送确认标识ACK=1和序列号，进入SYN-REVD状态。
+ 第三次握手，客户端接受服务器的确认标识和序列号，发送确认标识ACK=1进入ESTAB-LISTEN状态。

<img src="https://img-blog.csdnimg.cn/20200228094340701.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwNzgxMjkx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />

### TCP四次挥手

1. 过程

- 第一次挥手：客户端`FIN=1`，请求断开连接。
- 第二次挥手：服务`ACK=1`，接收到客户端的断开请求，进入断开连接等待状态。
- 第三次挥手：服务器端完成数据发送，`FIN=1`请求断开连接。
- 第四次挥手：客户端发送`ACK=1`断开请求。等待2MSL后断开连接

<img src="https://img-blog.csdnimg.cn/20200301165357722.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwNzgxMjkx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />

2. 为什么四次挥手
   服务器端接收到断开连接请求后还需要继续发送余下数据，发送完成后才可断开连接。

3. 为什么客户端等待2MSL（报文来回的时间）

- 可以确保客户端最后一次挥手`ACK=1`传递到服务器，让服务器进入关闭状态
- 可以确保下一次连接不存在遗留的报文段

## TCP如何保证数据传输

1. 超时重传

   发送后没有`ACK`相应则超时重传。RTO = RTO * 2

2. 滑动窗口

   发送方使用流量窗口对发送数据控制，防止接收方接受过多造成缓存溢出。

3. 拥塞控制

   + 慢开始

     探测网络。*2

   + 快重传

     接收方连续发送三个ACK使得发送方立刻重传

   + 快恢复

     拥塞窗口减半而后继续拥塞避免算法。

   + 拥塞避免

     拥塞窗口+1

### 用UDP实现TCP

- 重点在应用层实现：确认机制、重传机制和流量控制
- 发送方：包确认、包重传、包分片。
- 接收方：顺序校验、调整顺序。